- name: copy virtual hosts
  template: src=vhosts.conf.j2 dest=/etc/nginx/sites-available/{{item.name}}
  with_items: "{{ vhosts }}"

- name: create vhost simlink
  file: path=/etc/nginx/sites-enabled/{{item.name}}
        src=/etc/nginx/sites-available/{{item.name}}
        state=link
        force=yes
  with_items: "{{ vhosts }}"
  notify:
    - reload nginx

- name: create /etc/hosts entries
  lineinfile: 
    dest: /etc/hosts
    line: "127.0.0.1    {{ item.server_name }}"
    state: present
  with_items: "{{ vhosts }}"

- name: enable supervisor config
  template: src=supervisor.conf.j2 dest=/etc/supervisor/conf.d/{{item.name}}.conf
  with_items: "{{ vhosts }}"
  when: item.supervisor is defined
  notify:
    - reload supervisor